{
    "version": 3,
    "sources": [
        "..\\..\\..\\..\\src\\wx\\controller\\api\\goods.js"
    ],
    "names": [
        "Base",
        "require",
        "module",
        "exports",
        "indexAction",
        "model",
        "goodsList",
        "select",
        "success",
        "skuAction",
        "goodsId",
        "get",
        "specificationList",
        "getSpecificationList",
        "productList",
        "getProductList",
        "detailAction",
        "info",
        "where",
        "find",
        "gallery",
        "goods_id",
        "limit",
        "attribute",
        "field",
        "join",
        "order",
        "issue",
        "brand",
        "id",
        "brand_id",
        "commentCount",
        "value_id",
        "type_id",
        "count",
        "hotComment",
        "commentInfo",
        "think",
        "isEmpty",
        "commentUser",
        "user_id",
        "content",
        "Buffer",
        "toString",
        "add_time",
        "datetime",
        "Date",
        "nickname",
        "avatar",
        "pic_list",
        "comment_id",
        "comment",
        "data",
        "userHasCollect",
        "isUserHasCollect",
        "userId",
        "addFootprint",
        "categoryAction",
        "currentCategory",
        "parentCategory",
        "parent_id",
        "brotherCategory",
        "listAction",
        "categoryId",
        "brandId",
        "keyword",
        "isNew",
        "isHot",
        "page",
        "size",
        "sort",
        "goodsQuery",
        "whereMap",
        "is_new",
        "is_hot",
        "name",
        "add",
        "parseInt",
        "getTime",
        "orderMap",
        "retail_price",
        "filterCategory",
        "categoryIds",
        "getField",
        "parentIds",
        "concat",
        "category_id",
        "getCategoryWhereIn",
        "goodsData",
        "countSelect",
        "map",
        "v",
        "checked",
        "filterAction",
        "getChildCategoryId",
        "newAction",
        "bannerInfo",
        "url",
        "img_url",
        "hotAction",
        "relatedAction",
        "relatedGoodsIds",
        "relatedGoods",
        "goodsCategory",
        "countAction",
        "goodsCount",
        "is_delete",
        "is_on_sale"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\..\\src\\wx\\controller\\api\\goods.js",
    "sourcesContent": [
        "const Base = require('./base.js');\n\nmodule.exports = class extends Base {\n  async indexAction() {\n    const model = this.model('wx_goods');\n    const goodsList = await model.select();\n\n    return this.success(goodsList);\n  }\n\n  /**\n   * 获取sku信息，用于购物车编辑时选择规格\n   * @returns {Promise.<Promise|PreventPromise|void>}\n   */\n  async skuAction() {\n    const goodsId = this.get('id');\n    const model = this.model('wx_goods');\n\n    return this.success({\n      specificationList: await model.getSpecificationList(goodsId),\n      productList: await model.getProductList(goodsId)\n    });\n  }\n\n  /**\n   * 商品详情页数据\n   * @returns {Promise.<Promise|PreventPromise|void>}\n   */\n  async detailAction() {\n    const goodsId = this.get('id');\n    const model = this.model('wx_goods');\n\n    const info = await model.where({'id': goodsId}).find();\n    const gallery = await this.model('wx_goods_gallery').where({goods_id: goodsId}).limit(4).select();\n    const attribute = await this.model('wx_goods_attribute').field('wx_goods_attribute.value, wx_attribute.name').join('wx_attribute ON wx_goods_attribute.attribute_id=wx_attribute.id').order({'wx_goods_attribute.id': 'asc'}).where({'wx_goods_attribute.goods_id': goodsId}).select();\n    const issue = await this.model('wx_goods_issue').select();\n    const brand = await this.model('wx_brand').where({id: info.brand_id}).find();\n    const commentCount = await this.model('wx_comment').where({value_id: goodsId, type_id: 0}).count();\n    const hotComment = await this.model('wx_comment').where({value_id: goodsId, type_id: 0}).find();\n    let commentInfo = {};\n    if (!think.isEmpty(hotComment)) {\n      const commentUser = await this.model('wx_user').field(['nickname', 'username', 'avatar']).where({id: hotComment.user_id}).find();\n      commentInfo = {\n        content: new Buffer(hotComment.content, 'base64').toString(),\n        add_time: think.datetime(new Date(hotComment.add_time * 1000)),\n        nickname: commentUser.nickname,\n        avatar: commentUser.avatar,\n        pic_list: await this.model('wx_comment_picture').where({comment_id: hotComment.id}).select()\n      };\n    }\n\n    const comment = {\n      count: commentCount,\n      data: commentInfo\n    };\n\n    // 当前用户是否收藏\n    const userHasCollect = await this.model('wx_collect').isUserHasCollect(think.userId, 0, goodsId);\n\n    // 记录用户的足迹 TODO\n    await await this.model('wx_footprint').addFootprint(think.userId, goodsId);\n\n    // return this.json(jsonData);\n    return this.success({\n      info: info,\n      gallery: gallery,\n      attribute: attribute,\n      userHasCollect: userHasCollect,\n      issue: issue,\n      comment: comment,\n      brand: brand,\n      specificationList: await model.getSpecificationList(goodsId),\n      productList: await model.getProductList(goodsId)\n    });\n  }\n\n  /**\n   * 获取分类下的商品\n   * @returns {Promise.<*>}\n   */\n  async categoryAction() {\n    const model = this.model('wx_category');\n    const currentCategory = await model.where({id: this.get('id')}).find();\n    const parentCategory = await model.where({id: currentCategory.parent_id}).find();\n    const brotherCategory = await model.where({parent_id: currentCategory.parent_id}).select();\n\n    return this.success({\n      currentCategory: currentCategory,\n      parentCategory: parentCategory,\n      brotherCategory: brotherCategory\n    });\n  }\n\n  /**\n   * 获取商品列表\n   * @returns {Promise.<*>}\n   */\n  async listAction() {\n    const categoryId = this.get('categoryId');\n    const brandId = this.get('brandId');\n    const keyword = this.get('keyword');\n    const isNew = this.get('isNew');\n    const isHot = this.get('isHot');\n    const page = this.get('page');\n    const size = this.get('size');\n    const sort = this.get('sort');\n    const order = this.get('order');\n\n    const goodsQuery = this.model('wx_goods');\n\n    const whereMap = {};\n    if (!think.isEmpty(isNew)) {\n      whereMap.is_new = isNew;\n    }\n\n    if (!think.isEmpty(isHot)) {\n      whereMap.is_hot = isHot;\n    }\n\n    if (!think.isEmpty(keyword)) {\n      whereMap.name = ['like', `%${keyword}%`];\n      // 添加到搜索历史\n      await this.model('wx_search_history').add({\n        keyword: keyword,\n        user_id: think.userId,\n        add_time: parseInt(new Date().getTime() / 1000)\n      });\n    }\n\n    if (!think.isEmpty(brandId)) {\n      whereMap.brand_id = brandId;\n    }\n\n    // 排序\n    let orderMap = {};\n    if (sort === 'price') {\n      // 按价格\n      orderMap = {\n        retail_price: order\n      };\n    } else {\n      // 按商品添加时间\n      orderMap = {\n        id: 'desc'\n      };\n    }\n\n    // 筛选的分类\n    let filterCategory = [{\n      'id': 0,\n      'name': '全部',\n      'checked': false\n    }];\n\n    const categoryIds = await goodsQuery.where(whereMap).getField('category_id', 10000);\n    if (!think.isEmpty(categoryIds)) {\n      // 查找二级分类的parent_id\n      const parentIds = await this.model('wx_category').where({id: {'in': categoryIds}}).getField('parent_id', 10000);\n      // 一级分类\n      const parentCategory = await this.model('wx_category').field(['id', 'name']).order({'sort_order': 'asc'}).where({'id': {'in': parentIds}}).select();\n\n      if (!think.isEmpty(parentCategory)) {\n        filterCategory = filterCategory.concat(parentCategory);\n      }\n    }\n\n    // 加入分类条件\n    if (!think.isEmpty(categoryId) && parseInt(categoryId) > 0) {\n      whereMap.category_id = ['in', await this.model('wx_category').getCategoryWhereIn(categoryId)];\n    }\n\n    // 搜索到的商品\n    const goodsData = await goodsQuery.where(whereMap).field(['id', 'name', 'list_pic_url', 'retail_price']).order(orderMap).page(page, size).countSelect();\n    goodsData.filterCategory = filterCategory.map(function(v) {\n      v.checked = (think.isEmpty(categoryId) && v.id === 0) || v.id === parseInt(categoryId);\n      return v;\n    });\n    goodsData.goodsList = goodsData.data;\n\n    return this.success(goodsData);\n  }\n\n  /**\n   * 商品列表筛选的分类列表\n   * @returns {Promise.<Promise|void|PreventPromise>}\n   */\n  async filterAction() {\n    const categoryId = this.get('categoryId');\n    const keyword = this.get('keyword');\n    const isNew = this.get('isNew');\n    const isHot = this.get('isHot');\n\n    const goodsQuery = this.model('wx_goods');\n\n    if (!think.isEmpty(categoryId)) {\n      goodsQuery.where({category_id: {'in': await this.model('wx_category').getChildCategoryId(categoryId)}});\n    }\n\n    if (!think.isEmpty(isNew)) {\n      goodsQuery.where({is_new: isNew});\n    }\n\n    if (!think.isEmpty(isHot)) {\n      goodsQuery.where({is_hot: isHot});\n    }\n\n    if (!think.isEmpty(keyword)) {\n      goodsQuery.where({name: {'like': `%${keyword}%`}});\n    }\n\n    let filterCategory = [{\n      'id': 0,\n      'name': '全部'\n    }];\n\n    // 二级分类id\n    const categoryIds = await goodsQuery.getField('category_id', 10000);\n    if (!think.isEmpty(categoryIds)) {\n      // 查找二级分类的parent_id\n      const parentIds = await this.model('wx_category').where({id: {'in': categoryIds}}).getField('parent_id', 10000);\n      // 一级分类\n      const parentCategory = await this.model('wx_category').field(['id', 'name']).order({'sort_order': 'asc'}).where({'id': {'in': parentIds}}).select();\n\n      if (!think.isEmpty(parentCategory)) {\n        filterCategory = filterCategory.concat(parentCategory);\n      }\n    }\n\n    return this.success(filterCategory);\n  }\n\n  /**\n   * 新品首发\n   * @returns {Promise.<Promise|void|PreventPromise>}\n   */\n  async newAction() {\n    return this.success({\n      bannerInfo: {\n        url: '',\n        name: '坚持初心，为你寻觅世间好物',\n        img_url: 'http://yanxuan.nosdn.127.net/8976116db321744084774643a933c5ce.png'\n      }\n    });\n  }\n\n  /**\n   * 人气推荐\n   * @returns {Promise.<Promise|void|PreventPromise>}\n   */\n  async hotAction() {\n    return this.success({\n      bannerInfo: {\n        url: '',\n        name: '大家都在买的严选好物',\n        img_url: 'http://yanxuan.nosdn.127.net/8976116db321744084774643a933c5ce.png'\n      }\n    });\n  }\n\n  /**\n   * 商品详情页的大家都在看的商品\n   * @returns {Promise.<Promise|PreventPromise|void>}\n   */\n  async relatedAction() {\n    // 大家都在看商品,取出关联表的商品，如果没有则随机取同分类下的商品\n    const model = this.model('wx_goods');\n    const goodsId = this.get('id');\n    const relatedGoodsIds = await this.model('wx_related_goods').where({goods_id: goodsId}).getField('related_goods_id');\n    let relatedGoods = null;\n    if (think.isEmpty(relatedGoodsIds)) {\n      // 查找同分类下的商品\n      const goodsCategory = await model.where({id: goodsId}).find();\n      relatedGoods = await model.where({category_id: goodsCategory.category_id}).field(['id', 'name', 'list_pic_url', 'retail_price']).limit(8).select();\n    } else {\n      relatedGoods = await model.where({id: ['IN', relatedGoodsIds]}).field(['id', 'name', 'list_pic_url', 'retail_price']).select();\n    }\n\n    return this.success({\n      goodsList: relatedGoods\n    });\n  }\n\n  /**\n   * 在售的商品总数\n   * @returns {Promise.<Promise|PreventPromise|void>}\n   */\n  async countAction() {\n    const goodsCount = await this.model('wx_goods').where({is_delete: 0, is_on_sale: 1}).count('id');\n\n    return this.success({\n      goodsCount: goodsCount\n    });\n  }\n};\n"
    ]
}